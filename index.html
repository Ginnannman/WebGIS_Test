<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>ウェブGISテスト</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<!-- plugin-->
    <link rel="stylesheet" href="css/L.Control.MapCenterCoord.css"/>
    <link rel="stylesheet" href="css/Icon.css">
    <script src="js/L.Control.MapCenterCoord.js"></script>
    <script src="js/leaflet-hash.js"></script>
  
    <style>
      body {padding: 0; margin: 0}
      html, body, #map {height: 100%; width: 100%;}
    </style>
  </head>
  
  <body>
    <div id="map"></div>
    <script>
        var map = L.map('map', L.extend({
          preferCanvas:true,
          zoomControl:false,
          zoom: 10,
          center: [35.6602488,139.6831213],
        }, L.Hash.parseHash(location.hash)));

        L.control.scale({ maxWidth:250, position:'bottomright', imperial:false }).addTo(map);
        L.control.zoom({position:'topright'}).addTo(map);

        //地図タイル
        var gsi =L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', 
          {attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>"});
        var gsipale = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png',
          {attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>"});
        var gsiblank = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/blank/{z}/{x}/{y}.png',
          {attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>"});
        var gisphoto = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg',
          {attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>"});
        var osmjp = L.tileLayer('https://tile.openstreetmap.jp/{z}/{x}/{y}.png',
          {  attribution: "<a href='https://osm.org/copyright' target='_blank'>OpenStreetMap</a> contributors" });
        var mierunemono = L.tileLayer('https://tile.mierune.co.jp/mierune_mono/{z}/{x}/{y}.png',
          {attribution:  "Map tiles by <a href='http://mierune.co.jp' target='_blank'>MIERUNE</a>,under <a href='https://creativecommons.org/licenses/by/4.0/' target='_blank'>CC BY 4.0</a> &mdash; Mapdata: &copy; <a href='http://openstreetmap.org' target='_blank'>OpenStreetMap</a>contributors, under ODbL</a>"});
        var stamen = L.tileLayer('https://stamen-tiles.a.ssl.fastly.net/toner/{z}/{x}/{y}.png',
          {attribution: "Map tiles by <a href='http://stamen.com' target='_blank'>Stamen Design</a>, under <a href='http://creativecommons.org/licenses/by/3.0' target='_blank'>CC BY 3.0</a>. Data by <a href='http://openstreetmap.org' target='_blank'>OpenStreetMap</a>, under <a href='http://www.openstreetmap.org/copyright' target='_blank'>ODbL</a>."})
        
        

        //標準地域二次メッシュ
        $.getJSON("./data/hyoujun_mesh.geojson", function(data){
          hyoujun_mesh2 = L.geoJson(data,{
            onEachFeature: function(feature,layer){
              layer.bindPopup("メッシュ番号"+feature.properties.Name);
            },
            attribution: "<a href='https://www.geospatial.jp/ckan/dataset/biodic-mesh/resource/d9e78516-6ba5-4863-bfcd-31326f8984db?inner_span=True'>環境省自然環境局生物多様性センター作成データ</a>をもとに加工して作成。ライセンス：<a href='https://www.env.go.jp/mail.html'>政府標準利用規約</a>",
            style: {
              "color":'#1e90ff',
              "opacity": 0.5,
              "fillColor": '#87cefa',
              "fillOpacity": 0.2
            }
          });
          LayerControl.addOverlay(hyoujun_mesh2,"標準地域2次メッシュ");
          
        });

        //wikidata
        var group = L.layerGroup([],
          {attribution: "Powered by<a href= 'https://www.wikidata.org/' target='_blank'>Wikidata</a>"}
          );
          if (location.search.match(/^\?([a-zA-Z_]+)$/)) lang = RegExp.$1;

        map.on("moveend", function() {
          var bounds = map.getBounds();
          var sparql =
                    `SELECT ?place ?placeLabel ?location WHERE {
            SERVICE wikibase:box {
            ?place wdt:P625 ?location.
            bd:serviceParam wikibase:cornerWest "Point(${bounds.getWest()} ${bounds.getNorth()})"^^geo:wktLiteral.
            bd:serviceParam wikibase:cornerEast "Point(${bounds.getEast()} ${bounds.getSouth()})"^^geo:wktLiteral.
            }
            SERVICE wikibase:label { bd:serviceParam wikibase:language "[AUTO_LANGUAGE],ja,en". }
            } limit 2000`;
          group.clearLayers();
          fetch("https://query.wikidata.org/sparql?query=" + encodeURIComponent(sparql), {
            "headers": {
              "accept": "application/sparql-results+json"
            },
            "method": "GET",
            "mode": "cors"
          }).then(a => a.json()).then(a => {
            a.results.bindings.forEach(x => {
              if (x.location.value.match(/^Point\((.+) (.+)\)$/)) {
                var lon = parseFloat(RegExp.$1);
                var lat = parseFloat(RegExp.$2);
                var wikidataIcon = L.divIcon({
                  html:'<div>x.placeLabel.value</div>',
                  className: 'wikidata'
                })
                L.marker([lat, lon], {
                  icon: wikidataIcon
                }).addTo(group);
              }
            });
          });
        }).fire("moveend");

        //BaseMap
        var BaseMaps = {
          "地理院地図" : gsi,
          "地理院 淡色地図" : gsipale,
          "地理院 白地図" : gsiblank,
          "地理院 写真" : gisphoto,
          "オープンストリートマップ（日本）" : osmjp,
          "MIERUNE 白地図" : mierunemono,
          "Stamen Toner（白黒地図）" : stamen
        };
        //OverLay
        var OverLays = {
            "wikidata": group,
        };
        var LayerControl = L.control.layers(BaseMaps, OverLays, {collapsed:false, position:'topleft'}).addTo(map);
        gsi.addTo(map); 
        
        //中心十字・座標
        L.control.mapCenterCoord({position:'bottomleft', onMove:true, latlngFormat:'DMS', latlngDesignators:true}).addTo(map);

        //URLハッシュ
        L.hash(map);

       
    </script>
  </body>
</html>